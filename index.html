<!DOCTYPE html>
<html>
  <head>
    <title>Entorno Virtual Interactivo</title>
    <link rel="icon" href="data:," />
    <meta charset="utf-8" />
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <link rel="manifest" href="manifest.json" />
    <meta name="theme-color" content="#ECECEC" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script>
      if ("serviceWorker" in navigator) {
        window.addEventListener("load", function () {
          navigator.serviceWorker.register("service-worker.js");
        });
      }
    </script>
    <style>
      .hud-overlay {
        position: fixed;
        top: 20px;
        left: 20px;
        color: white;
        font-family: Arial, sans-serif;
        background: rgba(0, 0, 0, 0.7);
        padding: 10px;
        border-radius: 5px;
        z-index: 1000;
      }
    </style>
  </head>
  <body>
    <div id="mathHUD" class="hud-overlay" style="display: none">
      <h3 id="functionTitle">Analisis Matematico</h3>
      <p id="functionDescription">Selecciona una funcion para visualizar</p>
      <p id="functionDomain">Explora diferentes funciones en 3D</p>
    </div>

    <a-scene>
      <!-- Piso simple para referencia -->
      <a-plane
        position="0 0 0"
        rotation="-90 0 0"
        width="20"
        height="20"
        color="white"
      ></a-plane>
        <a-box
          width="0.5"
          height="0.2"
          depth="0.05"
          color="#FF5252"
          opacity="0.9"
          animation__mouseenter="property: scale; to: 1.1 1.1 1.1; startEvents: mouseenter; dur: 200"
          animation__mouseleave="property: scale; to: 1 1 1; startEvents: mouseleave; dur: 200"
        ></a-box>
        <a-text
          value="Salir VR"
          align="center"
          color="#fff"
          width="1.5"
          position="0 0 0.03"
        ></a-text>
      </a-entity>
      
      <!-- Piso simple para referencia -->
      <a-plane
        position="0 0 0"
        rotation="-90 0 0"
        width="20"
        height="20"
        color="white"
      ></a-plane>

      <!-- Escena Principal (Home) -->
      <a-entity id="scene-home">
        <!-- Logo 3D centrado y visible -->
        <a-entity
          id="logo3d"
          position="0 1.5 -0.8"
          scale="2 2 2"
          rotation="0 45 0"
          animation="property: rotation; to: 0 405 0; loop: true; dur: 8000; easing: linear"
        >
          <a-gltf-model src="./models-prueba/Iso.gltf"></a-gltf-model>
        </a-entity>

        <!-- Menu interactivo en el piso -->
        <a-entity id="menu" position="0 0.01 -2" rotation="-90 0 0">
          <a-box
            position="0 0 0"
            width="2.2"
            height="0.3"
            depth="0.05"
            color="#222"
            opacity="0.7"
          ></a-box>
          <a-entity
            id="btn-scene1"
            position="-0.7 0.05 0.03"
            class="clickable"
            cursor-target
          >
            <a-box
              width="0.6"
              height="0.18"
              depth="0.05"
              color="#4CAF50"
              opacity="0.9"
              animation__mouseenter="property: scale; to: 1.1 1.1 1.1; startEvents: mouseenter; dur: 200"
              animation__mouseleave="property: scale; to: 1 1 1; startEvents: mouseleave; dur: 200"
            ></a-box>
            <a-text
              value="Analisis Matematico"
              align="center"
              color="#fff"
              width="1.2"
              position="0 0 0.03"
            ></a-text>
          </a-entity>
          <a-entity
            id="btn-scene2"
            position="0 0.05 0.03"
            class="clickable"
            cursor-target
          >
            <a-box
              width="0.6"
              height="0.18"
              depth="0.05"
              color="#2196F3"
              opacity="0.9"
              animation__mouseenter="property: scale; to: 1.1 1.1 1.1; startEvents: mouseenter; dur: 200"
              animation__mouseleave="property: scale; to: 1 1 1; startEvents: mouseleave; dur: 200"
            ></a-box>
            <a-text
              value="Algoritmos"
              align="center"
              color="#fff"
              width="1.5"
              position="0 0 0.03"
            ></a-text>
          </a-entity>
          <a-entity
            id="btn-scene3"
            position="0.7 0.05 0.03"
            class="clickable"
            cursor-target
          >
            <a-box
              width="0.6"
              height="0.18"
              depth="0.05"
              color="#FFC107"
              opacity="0.9"
              animation__mouseenter="property: scale; to: 1.1 1.1 1.1; startEvents: mouseenter; dur: 200"
              animation__mouseleave="property: scale; to: 1 1 1; startEvents: mouseleave; dur: 200"
            ></a-box>
            <a-text
              value="Escena 3"
              align="center"
              color="#222"
              width="1.5"
              position="0 0 0.03"
            ></a-text>
          </a-entity>
        </a-entity>
      </a-entity>

      <!-- Escena 1: Analisis Matematico -->
  <a-entity id="scene-math" visible="false">
        <!-- Menu de Funciones Matematicas -->
        <a-entity id="math-menu" position="0 2 -3">
          <!-- Titulo principal -->
          <a-text
            value="Analisis Matematico"
            position="0 1.5 0"
            align="center"
            color="#4CAF50"
            width="12"
          ></a-text>

          <a-text
            value="Selecciona una funcion para visualizar:"
            position="0 1 0"
            align="center"
            color="#fff"
            width="8"
          ></a-text>

          <!-- Fila 1 de funciones -->
          <a-entity position="-2 0.3 0">
            <a-entity
              id="btn-func1"
              position="0 0 0"
              class="clickable function-btn"
              cursor-target
            >
              <a-box
                width="1.5"
                height="0.4"
                depth="0.08"
                color="#FF6B6B"
                opacity="0.9"
                animation__mouseenter="property: scale; to: 1.1 1.1 1.1; startEvents: mouseenter; dur: 200"
                animation__mouseleave="property: scale; to: 1 1 1; startEvents: mouseleave; dur: 200"
              ></a-box>
              <a-text
                value="sin(x) * cos(y)"
                align="center"
                color="#fff"
                width="4"
                position="0 0 0.05"
              ></a-text>
            </a-entity>
          </a-entity>

          <a-entity position="0 0.3 0">
            <a-entity
              id="btn-func2"
              position="0 0 0"
              class="clickable function-btn"
              cursor-target
            >
              <a-box
                width="1.5"
                height="0.4"
                depth="0.08"
                color="#4ECDC4"
                opacity="0.9"
                animation__mouseenter="property: scale; to: 1.1 1.1 1.1; startEvents: mouseenter; dur: 200"
                animation__mouseleave="property: scale; to: 1 1 1; startEvents: mouseleave; dur: 200"
              ></a-box>
              <a-text
                value="x² + y²"
                align="center"
                color="#fff"
                width="4"
                position="0 0 0.05"
              ></a-text>
            </a-entity>
          </a-entity>

          <a-entity position="2 0.3 0">
            <a-entity
              id="btn-func3"
              position="0 0 0"
              class="clickable function-btn"
              cursor-target
            >
              <a-box
                width="1.5"
                height="0.4"
                depth="0.08"
                color="#45B7D1"
                opacity="0.9"
                animation__mouseenter="property: scale; to: 1.1 1.1 1.1; startEvents: mouseenter; dur: 200"
                animation__mouseleave="property: scale; to: 1 1 1; startEvents: mouseleave; dur: 200"
              ></a-box>
              <a-text
                value="sin(√(x²+y²))"
                align="center"
                color="#fff"
                width="3.5"
                position="0 0 0.05"
              ></a-text>
            </a-entity>
          </a-entity>

          <!-- Fila 2 de funciones -->
          <a-entity position="-1 -0.3 0">
            <a-entity
              id="btn-func4"
              position="0 0 0"
              class="clickable function-btn"
              cursor-target
            >
              <a-box
                width="1.5"
                height="0.4"
                depth="0.08"
                color="#96CEB4"
                opacity="0.9"
                animation__mouseenter="property: scale; to: 1.1 1.1 1.1; startEvents: mouseenter; dur: 200"
                animation__mouseleave="property: scale; to: 1 1 1; startEvents: mouseleave; dur: 200"
              ></a-box>
              <a-text
                value="cos(x) * sin(y)"
                align="center"
                color="#fff"
                width="3.5"
                position="0 0 0.05"
              ></a-text>
            </a-entity>
          </a-entity>

          <a-entity position="1 -0.3 0">
            <a-entity
              id="btn-func5"
              position="0 0 0"
              class="clickable function-btn"
              cursor-target
            >
              <a-box
                width="1.5"
                height="0.4"
                depth="0.08"
                color="#FFEAA7"
                opacity="0.9"
                animation__mouseenter="property: scale; to: 1.1 1.1 1.1; startEvents: mouseenter; dur: 200"
                animation__mouseleave="property: scale; to: 1 1 1; startEvents: mouseleave; dur: 200"
              ></a-box>
              <a-text
                value="e^(-(x²+y²))"
                align="center"
                color="#333"
                width="3.5"
                position="0 0 0.05"
              ></a-text>
            </a-entity>
          </a-entity>

          <!-- Boton de regreso al menu principal -->
          <a-entity
            id="btn-back"
            position="0 -1 0"
            class="clickable"
            cursor-target
          >
            <a-box
              width="1.2"
              height="0.3"
              depth="0.08"
              color="#f44336"
              opacity="0.9"
              animation__mouseenter="property: scale; to: 1.1 1.1 1.1; startEvents: mouseenter; dur: 200"
              animation__mouseleave="property: scale; to: 1 1 1; startEvents: mouseleave; dur: 200"
            ></a-box>
            <a-text
              value="← Menu Principal"
              align="center"
              color="#fff"
              width="3"
              position="0 0 0.05"
            ></a-text>
          </a-entity>
        </a-entity>

        <!-- Area de visualizacion de funciones -->
        <a-entity id="function-display" visible="false">
          <!-- Titulo dinamico de la funcion -->
          <a-text
            id="current-function-title"
            value=""
            position="0 3 -3"
            align="center"
            color="#4CAF50"
            width="10"
          ></a-text>

          <!-- Superficie matematica -->
          <a-entity id="math-surface" position="0 1.5 -4"></a-entity>

          <!-- Ejes de coordenadas (solo visibles cuando se muestra una funcion) -->
          <!-- Eje X -->
          <a-cylinder
            position="0 1 -4"
            rotation="0 0 90"
            height="6"
            radius="0.02"
            color="red"
          ></a-cylinder>
          <a-text value="X" position="3.2 1 -4" color="red" width="4"></a-text>

          <!-- Eje Y -->
          <a-cylinder
            position="0 1 -4"
            height="6"
            radius="0.02"
            color="green"
          ></a-cylinder>
          <a-text
            value="Y"
            position="0 4.2 -4"
            color="green"
            width="4"
          ></a-text>

          <!-- Eje Z -->
          <a-cylinder
            position="0 1 -4"
            rotation="90 0 0"
            height="6"
            radius="0.02"
            color="blue"
          ></a-cylinder>
          <a-text value="Z" position="0 1 -0.8" color="blue" width="4"></a-text>

          <!-- Boton para regresar al menu de funciones -->
          <a-entity
            id="btn-back-to-menu"
            position="0 0.5 -2"
            class="clickable"
            cursor-target
          >
            <a-box
              width="1.2"
              height="0.3"
              depth="0.1"
              color="#9B59B6"
              opacity="0.9"
              animation__mouseenter="property: scale; to: 1.1 1.1 1.1; startEvents: mouseenter; dur: 200"
              animation__mouseleave="property: scale; to: 1 1 1; startEvents: mouseleave; dur: 200"
            ></a-box>
            <a-text
              value="← Menu Funciones"
              align="center"
              color="#fff"
              width="3"
              position="0 0 0.06"
            ></a-text>
          </a-entity>
        </a-entity>
      </a-entity>

      <!-- Escena 2: Algoritmos de Ordenamiento -->
      <a-entity id="scene-algorithms" visible="false">
        <!-- Menu de algoritmos -->
        <a-entity id="alg-menu" position="0 2 -3">
          <a-text
            value="Algoritmos de Ordenamiento"
            position="0 1.5 0"
            align="center"
            color="#2196F3"
            width="12"
          ></a-text>

          <a-text
            value="Selecciona un algoritmo para visualizar:" 
            position="0 1 0"
            align="center"
            color="#fff"
            width="8"
          ></a-text>

          <a-entity position="-1 0.3 0">
            <a-entity id="btn-algo1" class="clickable" cursor-target>
              <a-box width="1.5" height="0.4" depth="0.08" color="#FF6B6B" opacity="0.9"
                animation__mouseenter="property: scale; to: 1.1 1.1 1.1; startEvents: mouseenter; dur: 200"
                animation__mouseleave="property: scale; to: 1 1 1; startEvents: mouseleave; dur: 200"></a-box>
              <a-text value="Bubble Sort" align="center" color="#fff" width="3.5" position="0 0 0.05"></a-text>
            </a-entity>
          </a-entity>

          <a-entity position="1 0.3 0">
            <a-entity id="btn-algo2" class="clickable" cursor-target>
              <a-box width="1.5" height="0.4" depth="0.08" color="#4ECDC4" opacity="0.9"
                animation__mouseenter="property: scale; to: 1.1 1.1 1.1; startEvents: mouseenter; dur: 200"
                animation__mouseleave="property: scale; to: 1 1 1; startEvents: mouseleave; dur: 200"></a-box>
              <a-text value="Insertion Sort" align="center" color="#fff" width="3.5" position="0 0 0.05"></a-text>
            </a-entity>
          </a-entity>

          <a-entity position="0 -0.3 0">
            <a-entity id="btn-algo3" class="clickable" cursor-target>
              <a-box width="1.5" height="0.4" depth="0.08" color="#45B7D1" opacity="0.9"
                animation__mouseenter="property: scale; to: 1.1 1.1 1.1; startEvents: mouseenter; dur: 200"
                animation__mouseleave="property: scale; to: 1 1 1; startEvents: mouseleave; dur: 200"></a-box>
              <a-text value="Quick Sort" align="center" color="#fff" width="3.5" position="0 0 0.05"></a-text>
            </a-entity>
          </a-entity>

          <!-- Boton de regreso al menu principal -->
          <a-entity id="btn-back-alg" position="0 -1 0" class="clickable" cursor-target>
            <a-box width="1.2" height="0.3" depth="0.08" color="#f44336" opacity="0.9"
              animation__mouseenter="property: scale; to: 1.1 1.1 1.1; startEvents: mouseenter; dur: 200"
              animation__mouseleave="property: scale; to: 1 1 1; startEvents: mouseleave; dur: 200"></a-box>
            <a-text value="← Menu Principal" align="center" color="#fff" width="3" position="0 0 0.05"></a-text>
          </a-entity>
        </a-entity>

        <!-- Area de visualizacion de algoritmos -->
        <a-entity id="algorithm-display" visible="false">
          <a-text id="current-algo-title" value="" position="0 3 -3" align="center" color="#2196F3" width="10"></a-text>

          <!-- Contenedor donde se agregarán barras (representación del array) -->
          <a-entity id="algo-surface" position="0 1.2 -4"></a-entity>

          <!-- Boton para regresar al menu de algoritmos -->
          <a-entity id="btn-back-to-alg-menu" position="0 0.5 -2" class="clickable" cursor-target>
            <a-box width="1.2" height="0.3" depth="0.1" color="#9B59B6" opacity="0.9"></a-box>
            <a-text value="← Menu Algoritmos" align="center" color="#fff" width="3" position="0 0 0.06"></a-text>
          </a-entity>
        </a-entity>
      </a-entity>

      <!-- Luz y cielo -->
      <a-light type="point" position="2 4 4"></a-light>
      <a-light type="ambient" color="#404040"></a-light>
      <a-sky color="#ECECEC"></a-sky>

      <!-- HUD para la version -->
      <a-camera id="mainCamera" camera="fov: 75">
        <a-entity
          text="value: v1.0.5; color: #000; align: right; width: 1.5; anchor: right;"
          position="0.9 -0.7 -2"
        ></a-entity>
        <!-- Cursor para interaccion -->
        <a-cursor
          position="0 0 -1"
          geometry="primitive: ring; radiusInner: 0.02; radiusOuter: 0.03"
          material="color: white; shader: flat"
          animation__click="property: scale; startEvents: click; from: 0.1 0.1 0.1; to: 1 1 1; dur: 150"
          animation__fusing="property: scale; startEvents: fusing; from: 1 1 1; to: 0.1 0.1 0.1; dur: 1500"
        ></a-cursor>
      </a-camera>
    </a-scene>

    <script>
      // Sistema de navegacion entre escenas
      const scenes = {
        home: document.getElementById("scene-home"),
        math: document.getElementById("scene-math"),
        algorithms: document.getElementById("scene-algorithms"),
      };

      function showScene(sceneName) {
        // Ocultar todas las escenas
        Object.values(scenes).forEach((scene) => {
          scene.setAttribute("visible", false);
        });

        // Mostrar la escena seleccionada
        if (scenes[sceneName]) {
          scenes[sceneName].setAttribute("visible", true);
        }

        // Mostrar/ocultar HUD matematico
        const mathHUD = document.getElementById("mathHUD");
        const cameraEl = document.getElementById("mainCamera");
        if (sceneName === "math") {
          mathHUD.style.display = "block";
          showMathMenu();

          // Reposicionar cámara para una mejor perspectiva de la función
          if (cameraEl) {
            cameraEl.setAttribute("position", { x: 0, y: 2.5, z: 2.8 });
            const target = new THREE.Vector3(0, 1.5, -4);
            cameraEl.object3D.lookAt(target);
          }
        } else if (sceneName === "algorithms") {
          mathHUD.style.display = "block";
          showAlgorithmsMenu();

          // Reposicionar cámara para la vista de algoritmos
          if (cameraEl) {
            cameraEl.setAttribute("position", { x: 0, y: 2.2, z: 2.8 });
            const target = new THREE.Vector3(0, 1.2, -4);
            cameraEl.object3D.lookAt(target);
          }
        } else {
          mathHUD.style.display = "none";
          // Restaurar vista inicial en Home
          if (cameraEl) {
            cameraEl.setAttribute("position", { x: 0, y: 1.6, z: 0 });
            cameraEl.setAttribute("rotation", { x: 0, y: 0, z: 0 });
          }
        }
      }

      // Funcion para mostrar el menu de funciones matematicas
      function showMathMenu() {
        document.getElementById("math-menu").setAttribute("visible", true);
        document
          .getElementById("function-display")
          .setAttribute("visible", false);

        // Resetear HUD
        document.getElementById("functionTitle").textContent =
          "Analisis Matematico";
        document.getElementById("functionDescription").textContent =
          "Selecciona una funcion para visualizar";
        document.getElementById("functionDomain").textContent =
          "Explora diferentes funciones en 3D";
      }

      // Variable para evitar renderizado excesivo
      let lastRenderTime = 0;
      let isRenderingFunction = false;

      // Función para mostrar una función específica (con protección contra sobrecargas)
      function showFunction(functionKey) {
        // Evitar múltiples renderizaciones rápidas que puedan causar bloqueos
        const now = Date.now();
        if (now - lastRenderTime < 1000 || isRenderingFunction) {
          console.log("Renderizado evitado por protección de sobrecarga");
          return;
        }

        // Mostrar indicador de carga (opcional)
        document.getElementById("mathHUD").style.display = "block";
        document.getElementById("functionTitle").textContent = "Cargando...";
        
        // Cambiar visibilidad
        document.getElementById("math-menu").setAttribute("visible", false);
        document.getElementById("function-display").setAttribute("visible", true);

        // Establecer bandera para evitar renderizados múltiples
        isRenderingFunction = true;
        lastRenderTime = now;
        currentFunction = functionKey;
        
        // Retrasamos ligeramente la generación para permitir que la interfaz se actualice
        setTimeout(() => {
          generateMathSurface(functionKey);
          isRenderingFunction = false;
        }, 100);
      }

      // Definición de funciones matemáticas
      const mathFunctions = {
        func1: {
          name: "f(x,y) = sin(x) * cos(y)",
          description: "Funcion trigonometrica que crea ondas entrecruzadas",
          domain: "Dominio: x ∈ [-π, π], y ∈ [-π, π]",
          formula: (x, z) => Math.sin(x) * Math.cos(z),
        },
        func2: {
          name: "f(x,y) = x² + y²",
          description: "Paraboloide circular - forma de cuenco",
          domain: "Dominio: x ∈ [-2, 2], y ∈ [-2, 2]",
          formula: (x, z) => (x * x + z * z) * 0.3,
        },
        func3: {
          name: "f(x,y) = sin(√(x²+y²))",
          description: "Ondas circulares concentricas",
          domain: "Dominio: x ∈ [-3π, 3π], y ∈ [-3π, 3π]",
          formula: (x, z) => Math.sin(Math.sqrt(x * x + z * z)),
        },
        func4: {
          name: "f(x,y) = cos(x) * sin(y)",
          description: "Ondas trigonometricas perpendiculares",
          domain: "Dominio: x ∈ [-π, π], y ∈ [-π, π]",
          formula: (x, z) => Math.cos(x) * Math.sin(z),
        },
        func5: {
          name: "f(x,y) = e^(-(x²+y²))",
          description: "Distribucion gaussiana - campana 3D",
          domain: "Dominio: x ∈ [-2, 2], y ∈ [-2, 2]",
          formula: (x, z) => Math.exp(-(x * x + z * z)),
        },
      };

      // Variable global para la función actual
      let currentFunction = null;

      // Función para generar la superficie matemática
      function generateMathSurface(functionKey) {
        const surface = document.getElementById("math-surface");

        // Limpiar superficie anterior
        while (surface.firstChild) {
          surface.removeChild(surface.firstChild);
        }

        if (!mathFunctions[functionKey]) return;

        const func = mathFunctions[functionKey];
        
        // Detectar si estamos en un dispositivo VR para ajustar la calidad
        const isVRMode = AFRAME.utils.device.checkHeadsetConnected();
        const step = isVRMode ? 0.4 : 0.2; // Menos resolución en VR
        const range = isVRMode ? 2.5 : 3;  // Menos rango en VR

        // Crear una malla de cuadriláteros usando triángulos con manejo de errores
        try {
          let triangleCount = 0;
          const maxTriangles = 500; // Límite para dispositivos VR
          const isVR = AFRAME.utils.device.checkHeadsetConnected();
          
          for (let x = -range; x < range; x += step) {
            for (let z = -range; z < range; z += step) {
              // Limitar número total de triángulos para evitar sobrecarga
              if (isVR && triangleCount > maxTriangles) {
                console.log("Límite de triángulos alcanzado para VR");
                break;
              }
              
              // Calcular las 4 esquinas del cuadrilátero
              const x1 = x,
                x2 = x + step;
              const z1 = z,
                z2 = z + step;

              // Calcular las alturas usando la función matemática seleccionada
              let y1, y2, y3, y4;
              try {
                y1 = func.formula(x1, z1);
                y2 = func.formula(x2, z1);
                y3 = func.formula(x1, z2);
                y4 = func.formula(x2, z2);
                
                // Validar que no sean valores incorrectos (NaN o Infinity)
                if (!isFinite(y1) || !isFinite(y2) || !isFinite(y3) || !isFinite(y4)) {
                  continue; // Saltar este cuadrilátero
                }
              } catch (err) {
                console.error("Error calculando valores de la función:", err);
                continue; // Saltar este cuadrilátero
              }

              // Crear los dos triángulos que forman el cuadrilátero
              createTriangle(
                surface,
                [x1, y1, z1],
                [x2, y2, z1],
                [x1, y3, z2],
                (y1 + y2 + y3) / 3
              );
              triangleCount++;
              
              createTriangle(
                surface,
                [x2, y2, z1],
                [x2, y4, z2],
                [x1, y3, z2],
                (y2 + y4 + y3) / 3
              );
              triangleCount++;
            }
          }
          
          console.log(`Superficie generada con ${triangleCount} triángulos`);
        } catch (error) {
          console.error("Error generando superficie matemática:", error);
          // Mostrar mensaje de error al usuario
          document.getElementById("functionTitle").textContent = "Error al generar superficie";
          document.getElementById("functionDescription").textContent = 
            "Hubo un problema al mostrar esta función en VR";
        }

        // Actualizar información en el HUD
        updateMathHUD(func);
        
        // Si estamos en VR, asegurarnos de que el renderizado fue exitoso
        if (AFRAME.utils.device.checkHeadsetConnected()) {
          // Comprobar si la superficie se generó correctamente
          if (surface.childElementCount < 10) {
            console.warn("Fallback: Usando representación simple para VR");
            createSimpleVRRepresentation(surface, func);
          }
        }
      }

      // =========================
      // Algoritmos: visualizaciones
      // =========================

      function showAlgorithmsMenu() {
        document.getElementById("alg-menu").setAttribute("visible", true);
        document.getElementById("algorithm-display").setAttribute("visible", false);
        document.getElementById("current-algo-title").setAttribute("value", "");
        document.getElementById("mathHUD").style.display = "block";
        document.getElementById("functionTitle").textContent = "Algoritmos";
        document.getElementById("functionDescription").textContent = "Selecciona un algoritmo para visualizar";
        document.getElementById("functionDomain").textContent = "Observa cómo cambian las posiciones del array durante el ordenamiento";
      }

      // Mostrar un algoritmo específico
      function showAlgorithm(algoKey) {
        // ocultar menu y mostrar display
        document.getElementById("alg-menu").setAttribute("visible", false);
        document.getElementById("algorithm-display").setAttribute("visible", true);
        const title = {
          bubble: "Bubble Sort",
          insertion: "Insertion Sort",
          quick: "Quick Sort",
        }[algoKey] || "Algoritmo";
        document.getElementById("current-algo-title").setAttribute("value", title);
        document.getElementById("functionTitle").textContent = title;

        // generar barras y pasos
        const arr = generateRandomArray(12, 1, 12);
        generateAlgorithmBars(arr);
        const steps = getSortingSteps(algoKey, arr.slice());
        animateAlgorithmSteps(steps, 120);
      }

      function generateRandomArray(n, min, max) {
        const a = [];
        for (let i = 0; i < n; i++) a.push(Math.floor(Math.random() * (max - min + 1)) + min);
        return a;
      }

      function generateAlgorithmBars(array) {
        const parent = document.getElementById("algo-surface");
        // limpiar
        while (parent.firstChild) parent.removeChild(parent.firstChild);

        const spacing = 0.5;
        const totalWidth = (array.length - 1) * spacing;
        for (let i = 0; i < array.length; i++) {
          const val = array[i];
          const box = document.createElement("a-box");
          const height = Math.max(0.2, val * 0.2);
          const x = -totalWidth / 2 + i * spacing;
          box.setAttribute("width", 0.3);
          box.setAttribute("depth", 0.3);
          box.setAttribute("height", height);
          box.setAttribute("position", `${x} ${height / 2} 0`);
          box.setAttribute("color", "#4CAF50");
          box.setAttribute("class", "algo-bar");
          box.setAttribute("data-index", i);
          parent.appendChild(box);
        }
      }

      // Obtener pasos para cada algoritmo (solo swaps registrados)
      function getSortingSteps(algo, arr) {
        const steps = [];
        if (algo === "bubble") {
          const n = arr.length;
          for (let i = 0; i < n - 1; i++) {
            for (let j = 0; j < n - 1 - i; j++) {
              steps.push({ type: "compare", i: j, j: j + 1 });
              if (arr[j] > arr[j + 1]) {
                [arr[j], arr[j + 1]] = [arr[j + 1], arr[j]];
                steps.push({ type: "swap", i: j, j: j + 1 });
              }
            }
          }
        } else if (algo === "insertion") {
          for (let i = 1; i < arr.length; i++) {
            let j = i;
            while (j > 0) {
              steps.push({ type: "compare", i: j - 1, j: j });
              if (arr[j - 1] > arr[j]) {
                [arr[j - 1], arr[j]] = [arr[j], arr[j - 1]];
                steps.push({ type: "swap", i: j - 1, j: j });
              } else break;
              j--;
            }
          }
        } else if (algo === "quick") {
          // quicksort - record swaps via a helper
          function qsort(a, lo, hi) {
            if (lo >= hi) return;
            const pivot = a[hi];
            let p = lo;
            for (let k = lo; k < hi; k++) {
              steps.push({ type: "compare", i: k, j: hi });
              if (a[k] < pivot) {
                [a[k], a[p]] = [a[p], a[k]];
                steps.push({ type: "swap", i: k, j: p });
                p++;
              }
            }
            [a[p], a[hi]] = [a[hi], a[p]];
            steps.push({ type: "swap", i: p, j: hi });
            qsort(a, lo, p - 1);
            qsort(a, p + 1, hi);
          }
          qsort(arr, 0, arr.length - 1);
        }
        return steps;
      }

      // Animar pasos: swaps y destacando comparaciones
      function animateAlgorithmSteps(steps, delayMs) {
        const parent = document.getElementById("algo-surface");
        const bars = Array.from(parent.querySelectorAll(".algo-bar"));

        // Helper para actualizar array of bars by index attribute
        function findBarByIndex(idx) {
          return bars.find((b) => Number(b.getAttribute("data-index")) === idx);
        }

        steps.forEach((step, idx) => {
          setTimeout(() => {
            // reset colors
            bars.forEach((b) => b.setAttribute("color", "#4CAF50"));
            if (step.type === "compare") {
              const a = findBarByIndex(step.i);
              const b = findBarByIndex(step.j);
              if (a) a.setAttribute("color", "#FFC107");
              if (b) b.setAttribute("color", "#FFC107");
            } else if (step.type === "swap") {
              const a = findBarByIndex(step.i);
              const b = findBarByIndex(step.j);
              if (!a || !b) return;
              // swap heights and data-index
              const posA = a.getAttribute("position").split(" ").map(Number);
              const posB = b.getAttribute("position").split(" ").map(Number);
              const heightA = Number(a.getAttribute("height"));
              const heightB = Number(b.getAttribute("height"));

              // animate by setting new attributes (simple instant swap)
              a.setAttribute("height", heightB);
              a.setAttribute("position", `${posA[0]} ${heightB / 2} ${posA[2]}`);
              b.setAttribute("height", heightA);
              b.setAttribute("position", `${posB[0]} ${heightA / 2} ${posB[2]}`);

              // swap data-index to keep findBarByIndex consistent
              const idxA = a.getAttribute("data-index");
              const idxB = b.getAttribute("data-index");
              a.setAttribute("data-index", idxB);
              b.setAttribute("data-index", idxA);
            }

            // mark completed at the last step
            if (idx === steps.length - 1) {
              bars.forEach((b) => b.setAttribute("color", "#8BC34A"));
            }
          }, idx * delayMs);
        });
      }
      
      // Función de fallback para representación simple en VR
      function createSimpleVRRepresentation(parent, func) {
        // Limpiar superficie
        while (parent.firstChild) {
          parent.removeChild(parent.firstChild);
        }
        
        // Crear una representación más simple usando planos con textura de gradiente
        const plane = document.createElement("a-plane");
        plane.setAttribute("width", 5);
        plane.setAttribute("height", 5);
        plane.setAttribute("rotation", "-90 0 0");
        plane.setAttribute("material", {
          color: "#4285F4",
          opacity: 0.8,
          transparent: true,
          shader: "flat"
        });
        parent.appendChild(plane);
        
        // Añadir texto 3D que representa la fórmula
        const formulaText = document.createElement("a-text");
        formulaText.setAttribute("value", func.name);
        formulaText.setAttribute("position", "0 0.1 0");
        formulaText.setAttribute("rotation", "-90 0 0");
        formulaText.setAttribute("align", "center");
        formulaText.setAttribute("color", "white");
        formulaText.setAttribute("width", 4);
        parent.appendChild(formulaText);
      }

      // Función para actualizar el HUD con información de la función
      function updateMathHUD(func) {
        document.getElementById("functionTitle").textContent = func.name;
        document.getElementById("functionDescription").textContent =
          func.description;
        document.getElementById("functionDomain").textContent = func.domain;
        document
          .getElementById("current-function-title")
          .setAttribute("value", func.name);
      }

      // Función auxiliar para crear triángulos (optimizada)
      function createTriangle(parent, v1, v2, v3, avgHeight) {
        const triangle = document.createElement("a-triangle");

        // Configurar los vértices del triángulo
        triangle.setAttribute("geometry", {
          primitive: "triangle",
          vertexA: `${v1[0]} ${v1[1]} ${v1[2]}`,
          vertexB: `${v2[0]} ${v2[1]} ${v2[2]}`,
          vertexC: `${v3[0]} ${v3[1]} ${v3[2]}`,
        });

        // Color basado en la altura promedio
        const normalizedY = (avgHeight + 1) / 2; // Normalizar entre 0 y 1
        const color = `hsl(${240 + normalizedY * 120}, 70%, 60%)`;

        // Configurar material una sola vez (más eficiente)
        triangle.setAttribute("material", {
          color: color,
          side: "double",
          transparent: true,
          opacity: 0.8,
          shader: "flat" // Shader más simple para mejor rendimiento
        });

        parent.appendChild(triangle);
      }

      // Event listeners para los botones
      document.addEventListener("DOMContentLoaded", function () {
        // Mostrar escena inicial
        showScene("home");

        // Boton Analisis Matematico
        document
          .getElementById("btn-scene1")
          .addEventListener("click", function () {
            showScene("math");
          });

        // Botón Escena 2 (placeholder)
        document
          .getElementById("btn-scene2")
          .addEventListener("click", function () {
            showScene("algorithms");
          });

        // Botones y lógica para la escena de Algoritmos
        document.getElementById("btn-algo1").addEventListener("click", function () {
          showAlgorithm("bubble");
        });
        document.getElementById("btn-algo2").addEventListener("click", function () {
          showAlgorithm("insertion");
        });
        document.getElementById("btn-algo3").addEventListener("click", function () {
          showAlgorithm("quick");
        });

        document.getElementById("btn-back-alg").addEventListener("click", function () {
          showScene("home");
        });

        document.getElementById("btn-back-to-alg-menu").addEventListener("click", function () {
          // volver al menu de algoritmos
          document.getElementById("alg-menu").setAttribute("visible", true);
          document.getElementById("algorithm-display").setAttribute("visible", false);
        });

        // Botón Escena 3 (placeholder)
        document
          .getElementById("btn-scene3")
          .addEventListener("click", function () {
            alert("Escena 3 - Proximamente disponible");
          });

        // Boton regresar al menu principal
        document
          .getElementById("btn-back")
          .addEventListener("click", function () {
            showScene("home");
          });

        // Botones de funciones matemáticas
        document
          .getElementById("btn-func1")
          .addEventListener("click", function () {
            showFunction("func1");
          });

        document
          .getElementById("btn-func2")
          .addEventListener("click", function () {
            showFunction("func2");
          });

        document
          .getElementById("btn-func3")
          .addEventListener("click", function () {
            showFunction("func3");
          });

        document
          .getElementById("btn-func4")
          .addEventListener("click", function () {
            showFunction("func4");
          });

        document
          .getElementById("btn-func5")
          .addEventListener("click", function () {
            showFunction("func5");
          });

        // Boton regresar al menu de funciones
        document
          .getElementById("btn-back-to-menu")
          .addEventListener("click", function () {
            showMathMenu();
          });
      });

      // Agregar interactividad con el cursor de VR
      document.querySelector("a-scene").addEventListener("loaded", function () {
        const clickables = document.querySelectorAll(".clickable");
        clickables.forEach((element) => {
          element.addEventListener("mouseenter", function () {
            this.dispatchEvent(new CustomEvent("mouseenter"));
          });

          element.addEventListener("mouseleave", function () {
            this.dispatchEvent(new CustomEvent("mouseleave"));
          });
        });
      });
    </script>
  </body>
</html>
